#!/usr/bin/env python3
"""
Syst√®me complet Google Sheets pour ESPN NBA Fantasy
Transfert automatique de toutes les donn√©es + analyses avanc√©es
"""

import gspread
from google.oauth2.service_account import Credentials
import pandas as pd
from datetime import datetime, timedelta
import json
import logging
from typing import Dict, List, Any
import numpy as np
from espn_nba_advanced_analyzer import ESPNNBAAdvancedAnalyzer
from advanced_analysis_sheets import AdvancedAnalysisSheets

class CompleteGoogleSheetsSystem:
    """Syst√®me complet de transfert et analyse Google Sheets"""
    
    def __init__(self, league_id: int, season: int, my_team_name: str, 
                 credentials_file: str = "credentials.json", spreadsheet_id: str = None):
        self.league_id = league_id
        self.season = season
        self.my_team_name = my_team_name
        self.credentials_file = credentials_file
        self.spreadsheet_id = spreadsheet_id
        
        # Initialisation des composants
        self.setup_logging()
        self.setup_google_sheets()
        self.setup_analyzer()
        self.setup_analysis_sheets()
    
    def setup_logging(self):
        """Configure le logging"""
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s'
        )
        self.logger = logging.getLogger(__name__)
    
    def setup_google_sheets(self):
        """Configure la connexion Google Sheets"""
        try:
            scopes = [
                'https://www.googleapis.com/auth/spreadsheets',
                'https://www.googleapis.com/auth/drive'
            ]
            
            creds = Credentials.from_service_account_file(
                self.credentials_file, 
                scopes=scopes
            )
            
            self.gc = gspread.authorize(creds)
            
            if self.spreadsheet_id:
                self.spreadsheet = self.gc.open_by_key(self.spreadsheet_id)
            else:
                # Cr√©er un nouveau spreadsheet
                self.spreadsheet = self.gc.create(f"ESPN NBA Fantasy - {self.my_team_name}")
                self.spreadsheet_id = self.spreadsheet.id
                print(f"üìä Nouveau spreadsheet cr√©√©: {self.spreadsheet.url}")
            
            self.logger.info("‚úÖ Connexion Google Sheets √©tablie")
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur connexion Google Sheets: {e}")
            raise
    
    def setup_analyzer(self):
        """Configure l'analyseur ESPN"""
        self.analyzer = ESPNNBAAdvancedAnalyzer(
            self.league_id, 
            self.season, 
            self.my_team_name
        )
    
    def setup_analysis_sheets(self):
        """Configure les feuilles d'analyse"""
        self.analysis_creator = AdvancedAnalysisSheets(self.spreadsheet)
    
    def run_complete_system(self):
        """Ex√©cute le syst√®me complet de transfert et analyse"""
        self.logger.info("üöÄ D√©marrage du syst√®me complet Google Sheets")
        
        try:
            # 1. Collecte des donn√©es ESPN
            self.logger.info("üìä Collecte des donn√©es ESPN...")
            snapshot = self.analyzer.collect_daily_data()
            
            # 2. Cr√©ation des feuilles d'analyse
            self.logger.info("üìã Cr√©ation des feuilles d'analyse...")
            self.analysis_creator.create_all_analysis_sheets()
            
            # 3. Transfert des donn√©es vers Google Sheets
            self.logger.info("üì§ Transfert des donn√©es vers Google Sheets...")
            self.transfer_all_data(snapshot)
            
            # 4. Mise √† jour des analyses
            self.logger.info("üîç Mise √† jour des analyses...")
            self.update_all_analyses(snapshot)
            
            # 5. G√©n√©ration du rapport final
            self.logger.info("üìä G√©n√©ration du rapport final...")
            self.generate_final_report(snapshot)
            
            self.logger.info("‚úÖ Syst√®me complet ex√©cut√© avec succ√®s")
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur dans le syst√®me complet: {e}")
            raise
    
    def transfer_all_data(self, snapshot):
        """Transfert toutes les donn√©es vers Google Sheets"""
        try:
            # Donn√©es quotidiennes
            self._transfer_daily_data(snapshot)
            
            # R√©sum√© des √©quipes
            self._transfer_teams_summary(snapshot)
            
            # Joueurs d√©taill√©s
            self._transfer_players_detailed(snapshot)
            
            # Transactions
            self._transfer_transactions(snapshot)
            
            # Agents libres
            self._transfer_free_agents(snapshot)
            
            # Blessures
            self._transfer_injuries(snapshot)
            
            self.logger.info("‚úÖ Toutes les donn√©es transf√©r√©es")
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur transfert donn√©es: {e}")
    
    def _transfer_daily_data(self, snapshot):
        """Transfert les donn√©es quotidiennes"""
        try:
            worksheet = self.spreadsheet.worksheet('üìä Donn√©es Quotidiennes')
            worksheet.clear()
            
            # En-t√™tes
            headers = [
                'Date', 'Ligue', 'Saison', 'Type Scoring', '√âquipes Total',
                'Semaine Actuelle', 'Mon √âquipe', 'Mon Rang'
            ]
            worksheet.update('A1:H1', [headers])
            
            # Donn√©es
            current_date = datetime.now().strftime('%Y-%m-%d')
            my_team = next((team for team in snapshot.teams if team.is_my_team), None)
            
            row = [
                current_date,
                snapshot.league_id,
                snapshot.season,
                snapshot.scoring_type,
                len(snapshot.teams),
                getattr(snapshot, 'current_week', 1),
                self.my_team_name,
                my_team.ranking if my_team else 'N/A'
            ]
            
            worksheet.update('A2', [row])
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur transfert donn√©es quotidiennes: {e}")
    
    def _transfer_teams_summary(self, snapshot):
        """Transfert le r√©sum√© des √©quipes"""
        try:
            worksheet = self.spreadsheet.worksheet('üèÄ R√©sum√© √âquipes')
            worksheet.clear()
            
            # En-t√™tes
            headers = [
                'Date', '√âquipe', 'Manager', 'Mon √âquipe', 'Rang',
                'Points Totaux', 'Points Banc', 'Points Actifs',
                'Rebonds', 'Assists', 'Steals', 'Blocks', 'FG%', 'FT%', '3PM', 'TO'
            ]
            worksheet.update('A1:P1', [headers])
            
            # Donn√©es
            rows = []
            current_date = datetime.now().strftime('%Y-%m-%d')
            
            for team in snapshot.teams:
                row = [
                    current_date,
                    team.team_name,
                    team.manager,
                    'OUI' if team.is_my_team else 'NON',
                    team.ranking,
                    team.total_stats.get('points', 0),
                    team.bench_stats.get('points', 0),
                    team.active_stats.get('points', 0),
                    team.total_stats.get('rebounds', 0),
                    team.total_stats.get('assists', 0),
                    team.total_stats.get('steals', 0),
                    team.total_stats.get('blocks', 0),
                    team.total_stats.get('fg_percentage', 0),
                    team.total_stats.get('ft_percentage', 0),
                    team.total_stats.get('three_pointers', 0),
                    team.total_stats.get('turnovers', 0)
                ]
                rows.append(row)
            
            worksheet.update('A2', rows)
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur transfert r√©sum√© √©quipes: {e}")
    
    def _transfer_players_detailed(self, snapshot):
        """Transfert les d√©tails des joueurs"""
        try:
            worksheet = self.spreadsheet.worksheet('üë• Joueurs D√©taill√©s')
            worksheet.clear()
            
            # En-t√™tes
            headers = [
                'Date', '√âquipe', 'Mon √âquipe', 'Joueur', 'Position',
                'Statut', 'Banc', 'Points', 'Rebonds', 'Assists',
                'Steals', 'Blocks', 'FG%', 'FT%', '3PM', 'TO',
                'Efficacit√©', 'Usage%', 'Blessure', 'Minutes'
            ]
            worksheet.update('A1:T1', [headers])
            
            # Donn√©es
            rows = []
            current_date = datetime.now().strftime('%Y-%m-%d')
            
            for team in snapshot.teams:
                for player in team.roster:
                    row = [
                        current_date,
                        team.team_name,
                        'OUI' if team.is_my_team else 'NON',
                        player.name,
                        player.position,
                        player.status,
                        'OUI' if player.is_bench else 'NON',
                        player.points,
                        player.rebounds,
                        player.assists,
                        player.steals,
                        player.blocks,
                        player.fg_percentage,
                        player.ft_percentage,
                        player.three_pointers,
                        player.turnovers,
                        player.efficiency,
                        player.usage_rate,
                        player.injury_status,
                        player.minutes
                    ]
                    rows.append(row)
            
            worksheet.update('A2', rows)
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur transfert joueurs d√©taill√©s: {e}")
    
    def _transfer_transactions(self, snapshot):
        """Transfert les transactions"""
        try:
            worksheet = self.spreadsheet.worksheet('üîÑ Transactions')
            worksheet.clear()
            
            if not snapshot.transactions:
                worksheet.update('A1', [['Aucune transaction r√©cente']])
                return
            
            # En-t√™tes
            headers = ['Date', 'Type', 'Description', '√âquipe']
            worksheet.update('A1:D1', [headers])
            
            # Donn√©es
            rows = []
            for trans in snapshot.transactions:
                row = [
                    trans['date'],
                    trans['type'],
                    trans['description'],
                    trans['team']
                ]
                rows.append(row)
            
            worksheet.update('A2', rows)
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur transfert transactions: {e}")
    
    def _transfer_free_agents(self, snapshot):
        """Transfert les agents libres"""
        try:
            worksheet = self.spreadsheet.worksheet('üÜì Agents Libres')
            worksheet.clear()
            
            if not snapshot.free_agents:
                worksheet.update('A1', [['Aucun agent libre disponible']])
                return
            
            # En-t√™tes
            headers = [
                'Joueur', 'Position', '√âquipe NBA', 'Points', 'Rebonds',
                'Assists', 'Steals', 'Blocks', 'Disponibilit√©', 'Popularit√©'
            ]
            worksheet.update('A1:J1', [headers])
            
            # Donn√©es
            rows = []
            for fa in snapshot.free_agents:
                row = [
                    fa.get('name', ''),
                    fa.get('position', ''),
                    fa.get('team', ''),
                    fa.get('points', 0),
                    fa.get('rebounds', 0),
                    fa.get('assists', 0),
                    fa.get('steals', 0),
                    fa.get('blocks', 0),
                    fa.get('availability', ''),
                    fa.get('popularity', '')
                ]
                rows.append(row)
            
            worksheet.update('A2', rows)
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur transfert agents libres: {e}")
    
    def _transfer_injuries(self, snapshot):
        """Transfert les blessures"""
        try:
            worksheet = self.spreadsheet.worksheet('üè• Blessures')
            worksheet.clear()
            
            if not snapshot.injuries:
                worksheet.update('A1', [['Aucune information de blessure']])
                return
            
            # En-t√™tes
            headers = [
                'Joueur', '√âquipe', 'Statut', 'Date', 'Description',
                'Dur√©e Estim√©e', 'Impact', 'Recommandation'
            ]
            worksheet.update('A1:H1', [headers])
            
            # Donn√©es
            rows = []
            for injury in snapshot.injuries:
                row = [
                    injury.get('player', ''),
                    injury.get('team', ''),
                    injury.get('status', ''),
                    injury.get('date', ''),
                    injury.get('description', ''),
                    injury.get('duration', ''),
                    injury.get('impact', ''),
                    injury.get('recommendation', '')
                ]
                rows.append(row)
            
            worksheet.update('A2', rows)
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur transfert blessures: {e}")
    
    def update_all_analyses(self, snapshot):
        """Met √† jour toutes les analyses"""
        try:
            # Mise √† jour de l'analyse mon √©quipe
            self._update_my_team_analysis(snapshot)
            
            # Mise √† jour de l'optimisation ROTO
            self._update_roto_optimization(snapshot)
            
            # Mise √† jour de l'analyse du banc
            self._update_bench_analysis(snapshot)
            
            # Mise √† jour du dashboard
            self._update_dashboard(snapshot)
            
            self.logger.info("‚úÖ Toutes les analyses mises √† jour")
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur mise √† jour analyses: {e}")
    
    def _update_my_team_analysis(self, snapshot):
        """Met √† jour l'analyse de mon √©quipe"""
        try:
            worksheet = self.spreadsheet.worksheet('üëë Mon √âquipe - Analyse')
            
            # Trouve mon √©quipe
            my_team = next((team for team in snapshot.teams if team.is_my_team), None)
            if not my_team:
                return
            
            # Mise √† jour des donn√©es
            current_date = datetime.now().strftime('%Y-%m-%d')
            
            # R√©sum√© quotidien
            daily_data = [
                current_date,
                my_team.ranking,
                my_team.total_stats.get('points', 0),
                my_team.bench_stats.get('points', 0),
                my_team.active_stats.get('points', 0),
                my_team.bench_stats.get('points', 0) - my_team.active_stats.get('points', 0),
                'Calcul√© automatiquement',
                'Calcul√© automatiquement',
                'Calcul√© automatiquement'
            ]
            
            worksheet.update('A5:J5', [daily_data])
            
            # Donn√©es des joueurs
            player_rows = []
            for player in my_team.roster:
                row = [
                    player.name,
                    player.position,
                    player.status,
                    player.points,
                    player.rebounds,
                    player.assists,
                    player.steals,
                    player.blocks,
                    player.efficiency,
                    'Banc' if player.is_bench else 'Actif',
                    'Calcul√© automatiquement',
                    'Calcul√© automatiquement',
                    'Calcul√© automatiquement',
                    'Calcul√© automatiquement'
                ]
                player_rows.append(row)
            
            worksheet.update('A9', player_rows)
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur mise √† jour analyse mon √©quipe: {e}")
    
    def _update_roto_optimization(self, snapshot):
        """Met √† jour l'optimisation ROTO"""
        try:
            worksheet = self.spreadsheet.worksheet('üéØ Optimisation ROTO')
            
            # Trouve mon √©quipe
            my_team = next((team for team in snapshot.teams if team.is_my_team), None)
            if not my_team:
                return
            
            # Cat√©gories ROTO
            categories = [
                'Points', 'Rebonds', 'Assists', 'Steals', 'Blocks',
                'FG%', 'FT%', '3PM', 'Turnovers'
            ]
            
            # Mise √† jour des donn√©es
            for i, category in enumerate(categories, 2):
                # Donn√©es simul√©es (√† remplacer par de vraies donn√©es)
                row = [
                    category,
                    my_team.ranking,  # Rang actuel
                    my_team.total_stats.get('points', 0),  # Points
                    'Calcul√© automatiquement',  # √âcart leader
                    'Calcul√© automatiquement',  # Faiblesse
                    'Calcul√© automatiquement',  # Joueurs am√©lioration
                    'Calcul√© automatiquement',  # Actions sugg√©r√©es
                    'Calcul√© automatiquement'  # Priorit√©
                ]
                worksheet.update(f'A{i}:H{i}', [row])
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur mise √† jour optimisation ROTO: {e}")
    
    def _update_bench_analysis(self, snapshot):
        """Met √† jour l'analyse du banc"""
        try:
            worksheet = self.spreadsheet.worksheet('ü™ë Analyse Banc')
            
            # Trouve mon √©quipe
            my_team = next((team for team in snapshot.teams if team.is_my_team), None)
            if not my_team:
                return
            
            current_date = datetime.now().strftime('%Y-%m-%d')
            
            # Donn√©es du banc
            bench_points = my_team.bench_stats.get('points', 0)
            active_points = my_team.active_stats.get('points', 0)
            difference = bench_points - active_points
            
            bench_data = [
                current_date,
                bench_points,
                active_points,
                difference,
                'Calcul√© automatiquement',
                'Calcul√© automatiquement',
                'Calcul√© automatiquement',
                'Calcul√© automatiquement'
            ]
            
            worksheet.update('A5:H5', [bench_data])
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur mise √† jour analyse banc: {e}")
    
    def _update_dashboard(self, snapshot):
        """Met √† jour le dashboard"""
        try:
            worksheet = self.spreadsheet.worksheet('üìä Dashboard Principal')
            
            # Trouve mon √©quipe
            my_team = next((team for team in snapshot.teams if team.is_my_team), None)
            if not my_team:
                return
            
            current_date = datetime.now().strftime('%Y-%m-%d')
            
            # R√©sum√© quotidien
            daily_summary = [
                current_date,
                my_team.ranking,
                my_team.total_stats.get('points', 0),
                my_team.bench_stats.get('points', 0),
                my_team.active_stats.get('points', 0),
                my_team.bench_stats.get('points', 0) - my_team.active_stats.get('points', 0),
                'Calcul√© automatiquement',
                'Calcul√© automatiquement',
                'Calcul√© automatiquement'
            ]
            
            worksheet.update('A5:J5', [daily_summary])
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur mise √† jour dashboard: {e}")
    
    def generate_final_report(self, snapshot):
        """G√©n√®re le rapport final"""
        try:
            print("\n" + "="*80)
            print("üèÄ RAPPORT FINAL - SYST√àME GOOGLE SHEETS")
            print("="*80)
            
            # Statistiques g√©n√©rales
            print(f"\nüìä STATISTIQUES G√âN√âRALES")
            print(f"   üìÖ Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print(f"   üèÄ Ligue: {snapshot.league_id} - Saison {snapshot.season}")
            print(f"   üë• √âquipes: {len(snapshot.teams)}")
            print(f"   üîÑ Transactions: {len(snapshot.transactions)}")
            print(f"   üè• Blessures: {len(snapshot.injuries)}")
            
            # Mon √©quipe
            my_team = next((team for team in snapshot.teams if team.is_my_team), None)
            if my_team:
                print(f"\nüëë MON √âQUIPE: {my_team.team_name}")
                print(f"   üìà Rang: {my_team.ranking}")
                print(f"   ‚ö° Points totaux: {my_team.total_stats.get('points', 0):.1f}")
                print(f"   ü™ë Points banc: {my_team.bench_stats.get('points', 0):.1f}")
                print(f"   ‚ö° Points actifs: {my_team.active_stats.get('points', 0):.1f}")
                
                # Alerte si points perdus
                bench_points = my_team.bench_stats.get('points', 0)
                if bench_points > 15:
                    print(f"   ‚ö†Ô∏è  ALERTE: {bench_points:.1f} points perdus sur le banc!")
            
            # Feuilles cr√©√©es
            print(f"\nüìã FEUILLES GOOGLE SHEETS CR√â√âES")
            print(f"   üìä Donn√©es Quotidiennes")
            print(f"   üèÄ R√©sum√© √âquipes")
            print(f"   üë• Joueurs D√©taill√©s")
            print(f"   üîÑ Transactions")
            print(f"   üÜì Agents Libres")
            print(f"   üè• Blessures")
            print(f"   üëë Mon √âquipe - Analyse")
            print(f"   üéØ Optimisation ROTO")
            print(f"   ü™ë Analyse Banc")
            print(f"   üìä Dashboard Principal")
            
            print(f"\nüîó LIEN GOOGLE SHEETS: {self.spreadsheet.url}")
            print(f"\n‚úÖ SYST√àME COMPLET TERMIN√â AVEC SUCC√àS!")
            
        except Exception as e:
            self.logger.error(f"‚ùå Erreur g√©n√©ration rapport final: {e}")

def main():
    """Fonction principale du syst√®me complet"""
    print("üöÄ Syst√®me Complet Google Sheets ESPN NBA Fantasy")
    print("=" * 60)
    
    # Configuration
    LEAGUE_ID = 1557635339
    SEASON = 2026
    MY_TEAM_NAME = "Neon Cobras 99"
    
    try:
        # Initialisation du syst√®me
        system = CompleteGoogleSheetsSystem(
            league_id=LEAGUE_ID,
            season=SEASON,
            my_team_name=MY_TEAM_NAME
        )
        
        # Ex√©cution du syst√®me complet
        system.run_complete_system()
        
    except Exception as e:
        print(f"‚ùå Erreur dans le syst√®me complet: {e}")
        print("üîç V√©rifiez la configuration et les credentials")

if __name__ == "__main__":
    main()
